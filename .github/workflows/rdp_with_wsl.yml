name: RDP-Optimized

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-2022
    timeout-minutes: 360
    steps:
      - name: System Optimization
        shell: powershell
        run: |
          Write-Host "Optimizing system..." -ForegroundColor Cyan
          powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
          powercfg /change monitor-timeout-ac 0
          powercfg /change standby-timeout-ac 0
          Stop-Service -Name wuauserv -Force -ErrorAction SilentlyContinue
          Set-Service -Name wuauserv -StartupType Disabled -ErrorAction SilentlyContinue
          Write-Host "System optimization complete" -ForegroundColor Green

      - name: Install and Configure WSL with Ubuntu
        shell: powershell
        run: |
          Write-Host "Setting up WSL and Ubuntu..." -ForegroundColor Cyan
          wsl --update
          Start-Sleep -Seconds 5
          wsl --set-default-version 2
          Start-Sleep -Seconds 3
          wsl --install -d Ubuntu --no-launch
          Start-Sleep -Seconds 10
          
          $username = "harsh"
          $password = "kali"
          
          Write-Host "Configuring Ubuntu user..." -ForegroundColor Yellow
          
          $scriptContent = "useradd -m -s /bin/bash $username`necho '$username`:$password' | chpasswd`nusermod -aG sudo $username`necho '$username ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers"
          
          $setupScriptPath = "$env:TEMP\wsl_setup.sh"
          [System.IO.File]::WriteAllText($setupScriptPath, $scriptContent, [System.Text.Encoding]::UTF8)
          
          wsl -d Ubuntu -u root bash -c "bash /mnt/c/Users/runneradmin/AppData/Local/Temp/wsl_setup.sh"
          Start-Sleep -Seconds 3
          
          Write-Host "Updating Ubuntu..." -ForegroundColor Yellow
          wsl -d Ubuntu -u $username bash -c "sudo apt-get update -y && sudo apt-get install -y build-essential gdb python-is-python3 python3-pip"
          
          Remove-Item $setupScriptPath -Force -ErrorAction SilentlyContinue
          
          Write-Host "WSL Setup Complete - Username: $username" -ForegroundColor Green
          wsl --list --verbose

      - name: Configure RDP for Performance
        shell: powershell
        run: |
          Write-Host "Configuring RDP..." -ForegroundColor Cyan
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxInstanceCount" -Value 999999 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxConnectionTime" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxDisconnectionTime" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxIdleTime" -Value 0 -Force
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Restart-Service -Name TermService -Force
          Write-Host "RDP configured" -ForegroundColor Green

      - name: Create RDP User
        shell: powershell
        run: |
          $username = "rdpadmin"
          $password = "P@ssword!q218"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          if (-not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name $username -Password $securePass -PasswordNeverExpires -AccountNeverExpires -UserMayNotChangePassword
          }
          
          Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username -ErrorAction SilentlyContinue
          
          Write-Host "RDP user created" -ForegroundColor Green

      - name: Install Tailscale
        shell: powershell
        run: |
          Write-Host "Installing Tailscale..." -ForegroundColor Cyan
          
          $installer = "$env:TEMP\tailscale.msi"
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          
          $maxRetries = 3
          $downloaded = $false
          for ($i = 1; $i -le $maxRetries; $i++) {
              try {
                  Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $installer -UseBasicParsing -TimeoutSec 60
                  $downloaded = $true
                  break
              } catch {
                  Write-Host "Download attempt $i failed" -ForegroundColor Yellow
                  Start-Sleep -Seconds 5
              }
          }
          
          if ($downloaded) {
              Start-Process msiexec.exe -ArgumentList "/i `"$installer`" /quiet /norestart" -Wait
              Remove-Item $installer -Force
              Start-Sleep -Seconds 10
              Write-Host "Tailscale installed" -ForegroundColor Green
          }

      - name: Connect Tailscale
        shell: powershell
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host "Connecting to Tailscale..." -ForegroundColor Cyan
          
          $tsPath = "$env:ProgramFiles\Tailscale\tailscale.exe"
          
          $service = Get-Service -Name Tailscale -ErrorAction SilentlyContinue
          $timeout = 30
          $elapsed = 0
          while ((!$service -or $service.Status -ne 'Running') -and $elapsed -lt $timeout) {
              Start-Sleep -Seconds 2
              $elapsed += 2
              $service = Get-Service -Name Tailscale -ErrorAction SilentlyContinue
          }
          
          & $tsPath up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=gh-runner-$env:GITHUB_RUN_ID --accept-routes --shields-up=false
          
          Start-Sleep -Seconds 20
          
          $maxRetries = 10
          $tsIP = $null
          for ($i = 1; $i -le $maxRetries; $i++) {
              $tsIP = & $tsPath ip -4
              if ($tsIP -match '^\d+\.\d+\.\d+\.\d+$') { 
                  break 
              }
              Start-Sleep -Seconds 5
          }
          
          if ($tsIP) {
              echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
              Write-Host "Tailscale connected: $tsIP" -ForegroundColor Green
          }

      - name: Show Connection Info
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "==========================================" -ForegroundColor Green
          Write-Host "RDP CONNECTION READY" -ForegroundColor Green
          Write-Host "==========================================" -ForegroundColor Green
          Write-Host "Tailscale IP : $env:TAILSCALE_IP" -ForegroundColor Cyan
          Write-Host "Username     : rdpadmin" -ForegroundColor Cyan
          Write-Host "Password     : P@ssword!q218" -ForegroundColor Cyan
          Write-Host "==========================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "WSL Ubuntu Info:" -ForegroundColor Cyan
          Write-Host "  Username: harsh" -ForegroundColor White
          Write-Host "  Password: kali" -ForegroundColor White
          Write-Host "==========================================" -ForegroundColor Green

      - name: Keep Alive
        shell: powershell
        run: |
          $startTime = Get-Date
          $endTime = $startTime.AddMinutes(358)
          
          Write-Host "Session active - maintaining connection..." -ForegroundColor Green
          
          while ((Get-Date) -lt $endTime) {
              $elapsed = [math]::Round(((Get-Date) - $startTime).TotalMinutes, 1)
              $remaining = [math]::Round(($endTime - (Get-Date)).TotalMinutes, 1)
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Elapsed: $elapsed min | Remaining: $remaining min" -ForegroundColor Green
              Start-Sleep -Seconds 120
          }
