name: RDP Tailscale - Complete Fix

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: System Information
        run: |
          Write-Host "=== SYSTEM SPECIFICATIONS ===" -ForegroundColor Green
          Get-ComputerInfo | Select-Object CsProcessors, CsTotalPhysicalMemory, OsArchitecture
          $disk = Get-PSDrive C
          Write-Host "Storage: $([math]::Round(($disk.Used + $disk.Free)/1GB, 2)) GB" -ForegroundColor Cyan
          Write-Host "CPU Cores: $env:NUMBER_OF_PROCESSORS" -ForegroundColor Cyan
          
          # GPU Info
          $gpu = Get-CimInstance Win32_VideoController
          Write-Host "GPU: $($gpu.Name)" -ForegroundColor Cyan
          Write-Host "============================================" -ForegroundColor Green
          
      - name: Disable ALL Firewalls Completely
        run: |
          Write-Host "üî• DISABLING ALL FIREWALLS..." -ForegroundColor Red
          
          # Disable Windows Firewall for all profiles
          Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
          
          # Disable firewall via registry as backup
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy\StandardProfile" -Name "EnableFirewall" -Value 0 -Force
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy\DomainProfile" -Name "EnableFirewall" -Value 0 -Force
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy\PublicProfile" -Name "EnableFirewall" -Value 0 -Force
          
          # Using netsh to turn off firewall
          netsh advfirewall set allprofiles state off
          
          # Stop firewall service
          Stop-Service -Name mpssvc -Force -ErrorAction SilentlyContinue
          Set-Service -Name mpssvc -StartupType Disabled -ErrorAction SilentlyContinue
          
          Write-Host "‚úÖ ALL FIREWALLS DISABLED!" -ForegroundColor Green
          
      - name: Enable RDP Aggressively
        run: |
          Write-Host "üñ•Ô∏è Enabling RDP with ALL settings..." -ForegroundColor Cyan
          
          # Enable Remote Desktop via registry
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          
          # Disable Network Level Authentication
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          
          # Set security layer to RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          
          # Allow connections from any version
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MinEncryptionLevel" -Value 1 -Force
          
          # Configure RDP for best performance
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "ColorDepth" -Value 4 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "fDisableCam" -Value 0 -Force
          
          # Allow unlimited connections
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "MaxInstanceCount" -Value 999999 -Force
          
          # Enable RDP via Group Policy
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "fDenyTSConnections" -Value 0 -Force -ErrorAction SilentlyContinue
          
          Write-Host "‚úÖ RDP enabled!" -ForegroundColor Green
          
      - name: Configure Firewall Rules (Backup)
        run: |
          Write-Host "üîß Adding firewall rules as backup..." -ForegroundColor Cyan
          
          # Enable RDP firewall rule group
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
          
          # Delete any existing custom rules
          Remove-NetFirewallRule -DisplayName "Allow-RDP*" -ErrorAction SilentlyContinue
          
          # Create explicit allow rules for RDP
          New-NetFirewallRule -DisplayName "Allow-RDP-TCP" -Direction Inbound -Protocol TCP -LocalPort 3389 -Action Allow -Enabled True -Profile Any -ErrorAction SilentlyContinue
          New-NetFirewallRule -DisplayName "Allow-RDP-UDP" -Direction Inbound -Protocol UDP -LocalPort 3389 -Action Allow -Enabled True -Profile Any -ErrorAction SilentlyContinue
          
          # Allow ICMP (ping) from Tailscale
          New-NetFirewallRule -DisplayName "Allow-ICMP-Tailscale" -Direction Inbound -Protocol ICMPv4 -Action Allow -Enabled True -Profile Any -RemoteAddress 100.64.0.0/10 -ErrorAction SilentlyContinue
          
          # Using netsh as additional backup
          netsh advfirewall firewall add rule name="RDP-TCP-In" dir=in action=allow protocol=TCP localport=3389
          netsh advfirewall firewall add rule name="RDP-UDP-In" dir=in action=allow protocol=UDP localport=3389
          netsh advfirewall firewall add rule name="ICMP-Ping" dir=in action=allow protocol=icmpv4
          
          Write-Host "‚úÖ Firewall rules added!" -ForegroundColor Green

      - name: Create RDP User
        run: |
          Write-Host "üë§ Creating RDP user..." -ForegroundColor Cyan
          
          $username = "rdpuser"
          $password = "RDP@2024#Secure"
          
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          # Remove user if exists
          Remove-LocalUser -Name $username -ErrorAction SilentlyContinue
          
          # Create user
          New-LocalUser -Name $username -Password $securePass -AccountNeverExpires -PasswordNeverExpires -UserMayNotChangePassword
          
          # Add to groups
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          
          # Verify
          $user = Get-LocalUser -Name $username
          Write-Host "User created: $($user.Name)" -ForegroundColor Green
          Write-Host "Enabled: $($user.Enabled)" -ForegroundColor Green
          
      - name: Configure Auto-Login
        run: |
          Write-Host "üîê Configuring auto-login..." -ForegroundColor Cyan
          
          $username = "rdpuser"
          $password = "RDP@2024#Secure"
          
          $RegPath = "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon"
          Set-ItemProperty -Path $RegPath -Name "AutoAdminLogon" -Value "1" -Force
          Set-ItemProperty -Path $RegPath -Name "DefaultUserName" -Value $username -Force
          Set-ItemProperty -Path $RegPath -Name "DefaultPassword" -Value $password -Force
          Set-ItemProperty -Path $RegPath -Name "AutoLogonCount" -Value "999999" -Force
          
          New-Item -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\Personalization" -Force -ErrorAction SilentlyContinue
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\Personalization" -Name "NoLockScreen" -Value 1 -Force
          
          powercfg /SETACVALUEINDEX SCHEME_CURRENT SUB_NONE CONSOLELOCK 0
          powercfg /SETDCVALUEINDEX SCHEME_CURRENT SUB_NONE CONSOLELOCK 0
          
          Write-Host "‚úÖ Auto-login configured!" -ForegroundColor Green

      - name: Start and Verify RDP Service
        run: |
          Write-Host "üîÑ Starting RDP services..." -ForegroundColor Cyan
          
          # Enable and start Remote Desktop Services
          Set-Service -Name TermService -StartupType Automatic
          Start-Service -Name TermService -ErrorAction Stop
          
          # Enable and start RDP-related services
          Set-Service -Name UmRdpService -StartupType Automatic -ErrorAction SilentlyContinue
          Start-Service -Name UmRdpService -ErrorAction SilentlyContinue
          
          Set-Service -Name SessionEnv -StartupType Automatic -ErrorAction SilentlyContinue
          Start-Service -Name SessionEnv -ErrorAction SilentlyContinue
          
          # Wait for service to be ready
          Start-Sleep -Seconds 5
          
          # Verify TermService is running
          $termService = Get-Service -Name TermService
          if ($termService.Status -ne 'Running') {
              Write-Error "‚ùå TermService failed to start!"
              Get-Service -Name TermService | Format-List *
              exit 1
          }
          
          Write-Host "‚úÖ RDP service is running!" -ForegroundColor Green
          
          # Check if port 3389 is listening
          $listening = Get-NetTCPConnection -LocalPort 3389 -State Listen -ErrorAction SilentlyContinue
          if ($listening) {
              Write-Host "‚úÖ Port 3389 is LISTENING" -ForegroundColor Green
              $listening | Select-Object LocalAddress, LocalPort, State | Format-Table
          } else {
              Write-Host "‚ö†Ô∏è Port 3389 is NOT listening" -ForegroundColor Red
          }

      - name: Install Tailscale
        run: |
          Write-Host "üì• Installing Tailscale..." -ForegroundColor Cyan
          
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force
          
          Start-Sleep -Seconds 10
          
          Write-Host "‚úÖ Tailscale installed!" -ForegroundColor Green

      - name: Connect to Tailscale
        run: |
          Write-Host "üåê Connecting to Tailscale..." -ForegroundColor Cyan
          
          # Connect with all flags
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-rdp-$env:GITHUB_RUN_ID --accept-routes --accept-dns=false --advertise-tags=tag:github
          
          Start-Sleep -Seconds 5
          
          # Get Tailscale IP
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 30) {
              Start-Sleep -Seconds 3
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
              if ($tsIP) {
                  $tsIP = $tsIP.Trim()
                  if ($tsIP -match '^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$') {
                      break
                  }
                  $tsIP = $null
              }
              $retries++
              Write-Host "Waiting for Tailscale IP... Attempt $retries/30" -ForegroundColor Yellow
          }
          
          if (-not $tsIP) {
              Write-Error "‚ùå Tailscale IP not assigned after 30 attempts"
              & "$env:ProgramFiles\Tailscale\tailscale.exe" status
              exit 1
          }
          
          Write-Host "‚úÖ Tailscale IP: $tsIP" -ForegroundColor Green
          $tsIP | Out-File -FilePath "$env:TEMP\tailscale_ip.txt" -Force
          
          # Show full Tailscale status
          Write-Host "`n=== Tailscale Status ===" -ForegroundColor Cyan
          & "$env:ProgramFiles\Tailscale\tailscale.exe" status
          Write-Host "========================`n" -ForegroundColor Cyan

      - name: Performance Optimizations
        run: |
          Write-Host "‚ö° Applying performance optimizations..." -ForegroundColor Cyan
          
          # High Performance power plan
          powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
          powercfg /hibernate off
          
          # Disable Windows Defender
          Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
          
          # Network optimizations
          New-Item -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile" -Force -ErrorAction SilentlyContinue
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile" -Name "NetworkThrottlingIndex" -Value 0xffffffff -Force
          
          netsh int tcp set global autotuninglevel=normal
          netsh int tcp set global chimney=enabled
          netsh int tcp set global congestionprovider=ctcp
          
          # GPU acceleration
          New-Item -Path "HKCU:\Software\Microsoft\Avalon.Graphics" -Force -ErrorAction SilentlyContinue
          Set-ItemProperty -Path "HKCU:\Software\Microsoft\Avalon.Graphics" -Name "DisableHWAcceleration" -Value 0 -Force -ErrorAction SilentlyContinue
          
          Write-Host "‚úÖ Optimizations applied!" -ForegroundColor Green

      - name: Final Connectivity Test
        run: |
          $tsIP = Get-Content "$env:TEMP\tailscale_ip.txt" -Raw
          $tsIP = $tsIP.Trim()
          
          Write-Host "`n=== FINAL DIAGNOSTICS ===" -ForegroundColor Yellow
          
          # Check RDP service
          Write-Host "`n1. RDP Service Status:" -ForegroundColor Cyan
          Get-Service -Name TermService | Select-Object Name, Status, StartType | Format-Table
          
          # Check listening ports
          Write-Host "2. Listening Ports:" -ForegroundColor Cyan
          Get-NetTCPConnection -LocalPort 3389 -State Listen -ErrorAction SilentlyContinue | Select-Object LocalAddress, LocalPort, State | Format-Table
          
          # Check firewall status
          Write-Host "3. Firewall Status:" -ForegroundColor Cyan
          Get-NetFirewallProfile | Select-Object Name, Enabled | Format-Table
          
          # Check user
          Write-Host "4. RDP User Status:" -ForegroundColor Cyan
          Get-LocalUser -Name rdpuser | Select-Object Name, Enabled, PasswordRequired | Format-Table
          
          # Test local RDP
          Write-Host "5. Testing local RDP connection..." -ForegroundColor Cyan
          $localTest = Test-NetConnection -ComputerName localhost -Port 3389 -InformationLevel Quiet -WarningAction SilentlyContinue
          if ($localTest) {
              Write-Host "   ‚úÖ RDP is accepting connections locally" -ForegroundColor Green
          } else {
              Write-Host "   ‚ùå RDP is NOT accepting connections" -ForegroundColor Red
          }
          
          # Test Tailscale connectivity
          Write-Host "6. Testing Tailscale IP connectivity..." -ForegroundColor Cyan
          $tsTest = Test-NetConnection -ComputerName $tsIP -Port 3389 -InformationLevel Quiet -WarningAction SilentlyContinue
          if ($tsTest) {
              Write-Host "   ‚úÖ RDP is accessible via Tailscale" -ForegroundColor Green
          } else {
              Write-Host "   ‚ö†Ô∏è Cannot test from same machine (this is normal)" -ForegroundColor Yellow
          }
          
          Write-Host "`n========================`n" -ForegroundColor Yellow

      - name: Display Connection Information
        run: |
          $tsIP = Get-Content "$env:TEMP\tailscale_ip.txt" -Raw
          $tsIP = $tsIP.Trim()
          
          Write-Host ""
          Write-Host "============================================" -ForegroundColor Green
          Write-Host "  üñ•Ô∏è  RDP SERVER IS READY!" -ForegroundColor Green
          Write-Host "============================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "üìç CONNECTION DETAILS:" -ForegroundColor Yellow
          Write-Host "   IP Address: $tsIP" -ForegroundColor Cyan
          Write-Host "   Username: rdpuser" -ForegroundColor Cyan
          Write-Host "   Password: RDP@2024#Secure" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "üíª CONNECT USING:" -ForegroundColor Yellow
          Write-Host "   Windows: mstsc /v:$tsIP" -ForegroundColor White
          Write-Host "   Mac: Microsoft Remote Desktop app" -ForegroundColor White
          Write-Host "   Linux: rdesktop $tsIP or xfreerdp /v:$tsIP /u:rdpuser" -ForegroundColor White
          Write-Host ""
          Write-Host "‚úÖ STATUS:" -ForegroundColor Yellow
          Write-Host "   Firewall: COMPLETELY DISABLED" -ForegroundColor Green
          Write-Host "   RDP Service: RUNNING" -ForegroundColor Green
          Write-Host "   Port 3389: LISTENING" -ForegroundColor Green
          Write-Host "   Tailscale: CONNECTED" -ForegroundColor Green
          Write-Host "   Auto-Login: ENABLED" -ForegroundColor Green
          Write-Host "   Performance: OPTIMIZED" -ForegroundColor Green
          Write-Host ""
          Write-Host "============================================" -ForegroundColor Green
          Write-Host ""

      - name: Keep Alive
        run: |
          $tsIP = Get-Content "$env:TEMP\tailscale_ip.txt" -Raw
          $tsIP = $tsIP.Trim()
          
          $endTime = (Get-Date).AddHours(6)
          
          Write-Host "üî• Server running for 6 hours..." -ForegroundColor Green
          Write-Host "üìå Connect to: $tsIP" -ForegroundColor Cyan
          Write-Host ""
          
          while ((Get-Date) -lt $endTime) {
            $remaining = ($endTime - (Get-Date)).ToString("hh\:mm\:ss")
            
            # Verify RDP is still running
            $rdpRunning = Get-Service -Name TermService | Where-Object {$_.Status -eq 'Running'}
            $status = if ($rdpRunning) { "‚úÖ ONLINE" } else { "‚ùå OFFLINE" }
            
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] $status | ‚è∞ Time: $remaining | üìç IP: $tsIP" -ForegroundColor Cyan
            
            # Keep system active
            $wsh = New-Object -ComObject WScript.Shell
            $wsh.SendKeys('+{F15}')
            
            Start-Sleep -Seconds 300  # Update every 5 minutes
          }
          
          Write-Host ""
          Write-Host "‚èπÔ∏è 6 hour limit reached!" -ForegroundColor Yellow
