name: RDP Tailscale - Fixed

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Disable Windows Firewall Completely
        run: |
          Write-Host "üî• Disabling Windows Firewall..." -ForegroundColor Red
          
          # Disable all firewall profiles
          Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
          
          # Using netsh as backup
          netsh advfirewall set allprofiles state off
          
          Write-Host "‚úÖ Firewall disabled!" -ForegroundColor Green

      - name: Configure Core RDP Settings
        run: |
          Write-Host "üñ•Ô∏è Configuring RDP..." -ForegroundColor Cyan
          
          # Enable Remote Desktop and disable Network Level Authentication
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                             -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "SecurityLayer" -Value 0 -Force

          # Remove any existing rule with the same name to avoid duplication
          netsh advfirewall firewall delete rule name="RDP-Tailscale" 2>$null
          netsh advfirewall firewall delete rule name="ICMP-Tailscale" 2>$null
          
          # Allow incoming RDP connections
          netsh advfirewall firewall add rule name="RDP-Tailscale" `
            dir=in action=allow protocol=TCP localport=3389
          
          # Allow ICMP (ping)
          netsh advfirewall firewall add rule name="ICMP-Tailscale" `
            dir=in action=allow protocol=icmpv4

          # Restart the Remote Desktop service
          Restart-Service -Name TermService -Force
          
          Write-Host "‚úÖ RDP configured!" -ForegroundColor Green

      - name: Create RDP User with Simple Password
        run: |
          Write-Host "üë§ Creating RDP user..." -ForegroundColor Cyan
          
          # Simple username and password
          $username = "rdpuser"
          $password = "RDP@2024#Secure"
          
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          # Remove user if exists
          Remove-LocalUser -Name $username -ErrorAction SilentlyContinue
          
          # Create user
          New-LocalUser -Name $username -Password $securePass -AccountNeverExpires -PasswordNeverExpires -UserMayNotChangePassword
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          
          # Save credentials to environment variable
          echo "RDP_USER=$username" >> $env:GITHUB_ENV
          echo "RDP_PASS=$password" >> $env:GITHUB_ENV
          
          if (-not (Get-LocalUser -Name $username)) {
              Write-Error "User creation failed"
              exit 1
          }
          
          Write-Host "‚úÖ User created: $username" -ForegroundColor Green

      - name: Install Tailscale
        run: |
          Write-Host "üì• Installing Tailscale..." -ForegroundColor Cyan
          
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force
          
          # Wait for installation to complete
          Start-Sleep -Seconds 10
          
          Write-Host "‚úÖ Tailscale installed!" -ForegroundColor Green

      - name: Establish Tailscale Connection
        run: |
          Write-Host "üåê Connecting to Tailscale..." -ForegroundColor Cyan
          
          # Bring up Tailscale with the provided auth key
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID --accept-routes --accept-dns=false
          
          # Wait for Tailscale to assign an IP
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 20) {
              Start-Sleep -Seconds 5
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
              if ($tsIP) {
                  $tsIP = $tsIP.Trim()
                  if ($tsIP -match '^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$') {
                      break
                  }
                  $tsIP = $null
              }
              $retries++
              Write-Host "Waiting for Tailscale IP... Attempt $retries/20" -ForegroundColor Yellow
          }
          
          if (-not $tsIP) {
              Write-Error "Tailscale IP not assigned. Exiting."
              & "$env:ProgramFiles\Tailscale\tailscale.exe" status
              exit 1
          }
          
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "‚úÖ Tailscale connected: $tsIP" -ForegroundColor Green
      
      - name: Verify RDP Accessibility
        run: |
          Write-Host "üîç Verifying RDP..." -ForegroundColor Cyan
          Write-Host "Tailscale IP: $env:TAILSCALE_IP" -ForegroundColor Yellow
          
          # Check if RDP service is running
          $rdpService = Get-Service -Name TermService
          Write-Host "RDP Service Status: $($rdpService.Status)" -ForegroundColor Cyan
          
          # Check if port 3389 is listening
          $listening = Get-NetTCPConnection -LocalPort 3389 -State Listen -ErrorAction SilentlyContinue
          if ($listening) {
              Write-Host "‚úÖ Port 3389 is listening" -ForegroundColor Green
          } else {
              Write-Host "‚ö†Ô∏è Port 3389 might not be listening" -ForegroundColor Yellow
          }
          
          # Test connectivity to Tailscale IP
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue -InformationLevel Quiet
          if ($testResult) {
              Write-Host "‚úÖ RDP is accessible on Tailscale network" -ForegroundColor Green
          } else {
              Write-Host "‚ö†Ô∏è Self-test inconclusive (normal from same machine)" -ForegroundColor Yellow
          }

      - name: Apply Performance Optimizations
        run: |
          Write-Host "‚ö° Applying optimizations..." -ForegroundColor Cyan
          
          # High performance power plan
          powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
          powercfg /hibernate off
          
          # Disable Windows Defender
          Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
          
          # Network optimizations
          New-Item -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile" -Force -ErrorAction SilentlyContinue
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile" -Name "NetworkThrottlingIndex" -Value 0xffffffff -Force -ErrorAction SilentlyContinue
          
          netsh int tcp set global autotuninglevel=normal 2>$null
          netsh int tcp set global chimney=enabled 2>$null
          netsh int tcp set global congestionprovider=ctcp 2>$null
          netsh int tcp set global rss=enabled 2>$null
          
          # GPU acceleration
          New-Item -Path "HKCU:\Software\Microsoft\Avalon.Graphics" -Force -ErrorAction SilentlyContinue
          Set-ItemProperty -Path "HKCU:\Software\Microsoft\Avalon.Graphics" -Name "DisableHWAcceleration" -Value 0 -Force -ErrorAction SilentlyContinue
          
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "fEnableWddmDriver" -Value 1 -Force -ErrorAction SilentlyContinue
          
          Write-Host "‚úÖ Optimizations applied!" -ForegroundColor Green

      - name: Display System Information
        run: |
          Write-Host "`n=== SYSTEM INFORMATION ===" -ForegroundColor Green
          $computerInfo = Get-ComputerInfo | Select-Object CsProcessors, CsTotalPhysicalMemory, OsArchitecture
          $computerInfo | Format-List
          
          $disk = Get-PSDrive C
          Write-Host "Storage: $([math]::Round(($disk.Used + $disk.Free)/1GB, 2)) GB" -ForegroundColor Cyan
          Write-Host "CPU Cores: $env:NUMBER_OF_PROCESSORS" -ForegroundColor Cyan
          
          $gpu = Get-CimInstance Win32_VideoController
          Write-Host "GPU: $($gpu.Name)" -ForegroundColor Cyan
          
          $ram = Get-CimInstance Win32_OperatingSystem
          $totalRAM = [math]::Round($ram.TotalVisibleMemorySize/1MB, 2)
          $freeRAM = [math]::Round($ram.FreePhysicalMemory/1MB, 2)
          Write-Host "RAM: $totalRAM GB total, $freeRAM GB free" -ForegroundColor Cyan
          Write-Host "==========================`n" -ForegroundColor Green

      - name: Maintain Connection
        run: |
          Write-Host ""
          Write-Host "============================================" -ForegroundColor Green
          Write-Host "  üñ•Ô∏è  RDP SERVER IS READY!" -ForegroundColor Green
          Write-Host "============================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "üìç CONNECTION DETAILS:" -ForegroundColor Yellow
          Write-Host "   Address: $env:TAILSCALE_IP" -ForegroundColor Cyan
          Write-Host "   Username: $env:RDP_USER" -ForegroundColor Cyan
          Write-Host "   Password: $env:RDP_PASS" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "üíª CONNECT USING:" -ForegroundColor Yellow
          Write-Host "   Windows: mstsc /v:$env:TAILSCALE_IP" -ForegroundColor White
          Write-Host "   Mac: Microsoft Remote Desktop app" -ForegroundColor White
          Write-Host "   Linux: rdesktop $env:TAILSCALE_IP -u $env:RDP_USER" -ForegroundColor White
          Write-Host ""
          Write-Host "üß™ TEST PING FIRST:" -ForegroundColor Yellow
          Write-Host "   ping $env:TAILSCALE_IP" -ForegroundColor White
          Write-Host ""
          Write-Host "‚úÖ STATUS:" -ForegroundColor Yellow
          Write-Host "   Firewall: DISABLED ‚úÖ" -ForegroundColor Green
          Write-Host "   RDP Service: RUNNING ‚úÖ" -ForegroundColor Green
          Write-Host "   Tailscale: CONNECTED ‚úÖ" -ForegroundColor Green
          Write-Host "   ICMP Ping: ENABLED ‚úÖ" -ForegroundColor Green
          Write-Host "   Performance: OPTIMIZED ‚úÖ" -ForegroundColor Green
          Write-Host "   GPU Acceleration: ENABLED ‚úÖ" -ForegroundColor Green
          Write-Host ""
          Write-Host "============================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "‚è∞ Session will run for 6 hours..." -ForegroundColor Cyan
          Write-Host ""
          
          # Keep runner active for 6 hours with monitoring
          $endTime = (Get-Date).AddHours(6)
          $checkInterval = 300  # 5 minutes
          
          while ((Get-Date) -lt $endTime) {
              $remaining = ($endTime - (Get-Date)).ToString("hh\:mm\:ss")
              
              # Check RDP service status
              $rdpStatus = Get-Service -Name TermService
              $statusIcon = if ($rdpStatus.Status -eq 'Running') { "‚úÖ" } else { "‚ùå" }
              
              Write-Host "[$((Get-Date).ToString('HH:mm:ss'))] $statusIcon RDP Active | ‚è∞ Remaining: $remaining | üìç IP: $env:TAILSCALE_IP" -ForegroundColor Cyan
              
              # Keep system awake
              $wsh = New-Object -ComObject WScript.Shell
              $wsh.SendKeys('+{F15}')
              
              Start-Sleep -Seconds $checkInterval
          }
          
          Write-Host ""
          Write-Host "‚èπÔ∏è 6 hour session limit reached!" -ForegroundColor Yellow
