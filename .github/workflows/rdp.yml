name: Windows Latest Max Performance RDP

on:
  workflow_dispatch:

jobs:
  setup-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # ====================================================
    # SYSTEM INFO
    # ====================================================
    - name: Show System Info
      shell: powershell
      run: |
        Write-Host "===== SYSTEM INFO ====="
        systeminfo | findstr /B /C:"OS Name" /C:"OS Version"
        Get-CimInstance Win32_Processor | Select Name,NumberOfCores,NumberOfLogicalProcessors
        Get-CimInstance Win32_OperatingSystem | Select TotalVisibleMemorySize

    # ====================================================
    # ULTIMATE PERFORMANCE
    # ====================================================
    - name: Enable Ultimate Performance
      shell: powershell
      run: |
        $scheme = powercfg -duplicatescheme e9a42b02-d5df-448d-aa00-03f14749eb61
        $guid = ($scheme -split ' ')[3]
        powercfg /s $guid
        Write-Host "Ultimate Performance Enabled"

    # ====================================================
    # NETWORK STABILITY OPTIMIZATION
    # ====================================================
    - name: Optimize Network
      shell: powershell
      run: |
        netsh int tcp set global autotuninglevel=normal
        netsh int tcp set global rss=enabled
        netsh int tcp set global chimney=enabled
        netsh int tcp set global ecncapability=enabled
        netsh int tcp set global timestamps=disabled
        netsh int tcp set global initialRto=2000
        Write-Host "Network optimized for stability"

    # ====================================================
    # CREATE RDP USER
    # ====================================================
    - name: Create RDP User
      shell: powershell
      run: |
        $username = "rdpadmin"
        $password = "P@assword!q218"
        $secure = ConvertTo-SecureString $password -AsPlainText -Force

        if (-not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $username `
              -Password $secure `
              -PasswordNeverExpires `
              -UserMayNotChangePassword
        }

        Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username -ErrorAction SilentlyContinue

        Write-Host "RDP user created"

    # ====================================================
    # ENABLE RDP
    # ====================================================
    - name: Enable RDP
      shell: powershell
      run: |
        Set-ItemProperty `
          -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
          -Name "fDenyTSConnections" -Value 0

        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Write-Host "RDP Enabled"

    # ====================================================
    # RDP PERFORMANCE TUNING
    # ====================================================
    - name: Optimize RDP Rendering
      shell: powershell
      run: |
        $policyPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services"
        New-Item -Path $policyPath -Force -ErrorAction SilentlyContinue
        Set-ItemProperty -Path $policyPath -Name "bEnforceGpuPreference" -Value 1 -Type DWord -Force

        Set-ItemProperty `
          -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" `
          -Name "VisualFXSetting" `
          -Value 2 -Force

        Start-Service -Name "TermService"
        Start-Sleep -Seconds 5

        Write-Host "RDP optimized"

    # ====================================================
    # INSTALL TAILSCALE
    # ====================================================
    - name: Install Tailscale
      shell: powershell
      run: |
        Invoke-WebRequest `
          -Uri https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe `
          -OutFile tailscale-setup.exe

        Start-Process .\tailscale-setup.exe -ArgumentList "/S" -Wait
        Write-Host "Tailscale installed"

    # ====================================================
    # CONNECT TAILSCALE
    # ====================================================
    - name: Connect Tailscale
      shell: powershell
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        $tailscalePath = "C:\Program Files\Tailscale\tailscale.exe"

        if (-not (Test-Path $tailscalePath)) {
            Write-Error "Tailscale not found"
            exit 1
        }

        & "$tailscalePath" up --authkey $env:TAILSCALE_AUTH_KEY --accept-routes
        Write-Host "Connected to Tailscale"

    # ====================================================
    # SHOW INFO
    # ====================================================
    - name: Show RDP Info
      shell: powershell
      run: |
        $tailscalePath = "C:\Program Files\Tailscale\tailscale.exe"
        $ip = & "$tailscalePath" ip -4

        Write-Host ""
        Write-Host "======================================"
        Write-Host "WINDOWS-LATEST RDP READY"
        Write-Host "======================================"
        Write-Host ""
        Write-Host "RDP Address: $ip"
        Write-Host "Username: rdpadmin"
        Write-Host "Password: P@assword!q218"
        Write-Host ""
        Write-Host "Session active for 6 hours"

    # ====================================================
    # KEEP ALIVE (MAX 6 HOURS)
    # ====================================================
    - name: Keep Session Alive
      shell: powershell
      run: |
        Start-Sleep -Seconds 21400
