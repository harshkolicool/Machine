name: RDP Tailscale - Working

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: System Information
        run: |
          Write-Host "=== SYSTEM SPECIFICATIONS ===" -ForegroundColor Green
          Get-ComputerInfo | Select-Object CsProcessors, CsTotalPhysicalMemory, OsArchitecture
          $disk = Get-PSDrive C
          Write-Host "Storage: $([math]::Round(($disk.Used + $disk.Free)/1GB, 2)) GB" -ForegroundColor Cyan
          Write-Host "CPU Cores: $env:NUMBER_OF_PROCESSORS" -ForegroundColor Cyan
          
          $gpu = Get-CimInstance Win32_VideoController
          Write-Host "GPU: $($gpu.Name)" -ForegroundColor Cyan
          Write-Host "============================================" -ForegroundColor Green
          
      - name: Disable ALL Firewalls Completely
        run: |
          Write-Host "üî• DISABLING ALL FIREWALLS..." -ForegroundColor Red
          
          Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
          
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy\StandardProfile" -Name "EnableFirewall" -Value 0 -Force
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy\DomainProfile" -Name "EnableFirewall" -Value 0 -Force
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy\PublicProfile" -Name "EnableFirewall" -Value 0 -Force
          
          netsh advfirewall set allprofiles state off
          
          Stop-Service -Name mpssvc -Force -ErrorAction SilentlyContinue
          Set-Service -Name mpssvc -StartupType Disabled -ErrorAction SilentlyContinue
          
          Write-Host "‚úÖ ALL FIREWALLS DISABLED!" -ForegroundColor Green
          
      - name: Enable RDP Aggressively
        run: |
          Write-Host "üñ•Ô∏è Enabling RDP..." -ForegroundColor Cyan
          
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MinEncryptionLevel" -Value 1 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "ColorDepth" -Value 4 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "fDisableCam" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "MaxInstanceCount" -Value 999999 -Force
          
          New-Item -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Force -ErrorAction SilentlyContinue
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "fDenyTSConnections" -Value 0 -Force -ErrorAction SilentlyContinue
          
          Write-Host "‚úÖ RDP enabled!" -ForegroundColor Green
          
      - name: Configure Firewall Rules
        run: |
          Write-Host "üîß Adding firewall rules..." -ForegroundColor Cyan
          
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
          
          Remove-NetFirewallRule -DisplayName "Allow-RDP*" -ErrorAction SilentlyContinue
          
          New-NetFirewallRule -DisplayName "Allow-RDP-TCP" -Direction Inbound -Protocol TCP -LocalPort 3389 -Action Allow -Enabled True -Profile Any -ErrorAction SilentlyContinue
          New-NetFirewallRule -DisplayName "Allow-RDP-UDP" -Direction Inbound -Protocol UDP -LocalPort 3389 -Action Allow -Enabled True -Profile Any -ErrorAction SilentlyContinue
          New-NetFirewallRule -DisplayName "Allow-ICMP-All" -Direction Inbound -Protocol ICMPv4 -Action Allow -Enabled True -Profile Any -ErrorAction SilentlyContinue
          
          netsh advfirewall firewall add rule name="RDP-TCP-In" dir=in action=allow protocol=TCP localport=3389
          netsh advfirewall firewall add rule name="RDP-UDP-In" dir=in action=allow protocol=UDP localport=3389
          netsh advfirewall firewall add rule name="ICMP-Ping" dir=in action=allow protocol=icmpv4
          
          Write-Host "‚úÖ Firewall rules added!" -ForegroundColor Green

      - name: Create RDP User
        run: |
          Write-Host "üë§ Creating RDP user..." -ForegroundColor Cyan
          
          $username = "rdpuser"
          $password = "RDP@2024#Secure"
          
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          Remove-LocalUser -Name $username -ErrorAction SilentlyContinue
          
          New-LocalUser -Name $username -Password $securePass -AccountNeverExpires -PasswordNeverExpires -UserMayNotChangePassword
          
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          
          $user = Get-LocalUser -Name $username
          Write-Host "‚úÖ User created: $($user.Name) | Enabled: $($user.Enabled)" -ForegroundColor Green
          
      - name: Configure Auto-Login
        run: |
          Write-Host "üîê Configuring auto-login..." -ForegroundColor Cyan
          
          $username = "rdpuser"
          $password = "RDP@2024#Secure"
          
          $RegPath = "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon"
          Set-ItemProperty -Path $RegPath -Name "AutoAdminLogon" -Value "1" -Force
          Set-ItemProperty -Path $RegPath -Name "DefaultUserName" -Value $username -Force
          Set-ItemProperty -Path $RegPath -Name "DefaultPassword" -Value $password -Force
          Set-ItemProperty -Path $RegPath -Name "AutoLogonCount" -Value "999999" -Force
          
          New-Item -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\Personalization" -Force -ErrorAction SilentlyContinue
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\Personalization" -Name "NoLockScreen" -Value 1 -Force
          
          powercfg /SETACVALUEINDEX SCHEME_CURRENT SUB_NONE CONSOLELOCK 0
          powercfg /SETDCVALUEINDEX SCHEME_CURRENT SUB_NONE CONSOLELOCK 0
          
          Write-Host "‚úÖ Auto-login configured!" -ForegroundColor Green

      - name: Start RDP Services
        run: |
          Write-Host "üîÑ Starting RDP services..." -ForegroundColor Cyan
          
          Set-Service -Name TermService -StartupType Automatic
          Start-Service -Name TermService -ErrorAction Stop
          
          Set-Service -Name UmRdpService -StartupType Automatic -ErrorAction SilentlyContinue
          Start-Service -Name UmRdpService -ErrorAction SilentlyContinue
          
          Set-Service -Name SessionEnv -StartupType Automatic -ErrorAction SilentlyContinue
          Start-Service -Name SessionEnv -ErrorAction SilentlyContinue
          
          Start-Sleep -Seconds 5
          
          $termService = Get-Service -Name TermService
          if ($termService.Status -ne 'Running') {
              Write-Error "‚ùå TermService failed to start!"
              exit 1
          }
          
          Write-Host "‚úÖ RDP service running!" -ForegroundColor Green
          
          $listening = Get-NetTCPConnection -LocalPort 3389 -State Listen -ErrorAction SilentlyContinue
          if ($listening) {
              Write-Host "‚úÖ Port 3389 is LISTENING" -ForegroundColor Green
          } else {
              Write-Host "‚ö†Ô∏è Port 3389 NOT listening" -ForegroundColor Red
          }

      - name: Install Tailscale
        run: |
          Write-Host "üì• Installing Tailscale..." -ForegroundColor Cyan
          
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force
          
          Start-Sleep -Seconds 10
          
          Write-Host "‚úÖ Tailscale installed!" -ForegroundColor Green

      - name: Connect to Tailscale (FIXED - No Tags)
        run: |
          Write-Host "üåê Connecting to Tailscale..." -ForegroundColor Cyan
          
          # FIXED: Removed --advertise-tags flag that was causing the error
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-rdp-$env:GITHUB_RUN_ID --accept-routes --accept-dns=false
          
          Start-Sleep -Seconds 10
          
          # Get Tailscale IP with better error handling
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 30) {
              Start-Sleep -Seconds 3
              try {
                  $output = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>&1
                  if ($output -and $output -match '^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$') {
                      $tsIP = $output.Trim()
                      break
                  }
              } catch {
                  # Ignore errors and retry
              }
              $retries++
              Write-Host "Waiting for Tailscale IP... Attempt $retries/30" -ForegroundColor Yellow
          }
          
          if (-not $tsIP) {
              Write-Host "‚ùå Failed to get Tailscale IP" -ForegroundColor Red
              Write-Host "Tailscale Status:" -ForegroundColor Yellow
              & "$env:ProgramFiles\Tailscale\tailscale.exe" status
              exit 1
          }
          
          Write-Host "‚úÖ Tailscale IP: $tsIP" -ForegroundColor Green
          $tsIP | Out-File -FilePath "$env:TEMP\tailscale_ip.txt" -Force
          
          Write-Host "`n=== Tailscale Status ===" -ForegroundColor Cyan
          & "$env:ProgramFiles\Tailscale\tailscale.exe" status
          Write-Host "========================`n" -ForegroundColor Cyan

      - name: Performance Optimizations
        run: |
          Write-Host "‚ö° Applying optimizations..." -ForegroundColor Cyan
          
          powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
          powercfg /hibernate off
          
          Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
          
          New-Item -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile" -Force -ErrorAction SilentlyContinue
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile" -Name "NetworkThrottlingIndex" -Value 0xffffffff -Force
          
          netsh int tcp set global autotuninglevel=normal
          netsh int tcp set global chimney=enabled
          netsh int tcp set global congestionprovider=ctcp
          netsh int tcp set global rss=enabled
          
          $adapters = Get-NetAdapter | Where-Object {$_.Status -eq "Up"}
          foreach ($adapter in $adapters) {
            Set-DnsClientServerAddress -InterfaceAlias $adapter.Name -ServerAddresses ("1.1.1.1","8.8.8.8") -ErrorAction SilentlyContinue
          }
          
          New-Item -Path "HKCU:\Software\Microsoft\Avalon.Graphics" -Force -ErrorAction SilentlyContinue
          Set-ItemProperty -Path "HKCU:\Software\Microsoft\Avalon.Graphics" -Name "DisableHWAcceleration" -Value 0 -Force -ErrorAction SilentlyContinue
          
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "fEnableWddmDriver" -Value 1 -Force -ErrorAction SilentlyContinue
          
          Write-Host "‚úÖ Optimizations applied!" -ForegroundColor Green

      - name: Final Diagnostics
        run: |
          $tsIP = Get-Content "$env:TEMP\tailscale_ip.txt" -Raw
          $tsIP = $tsIP.Trim()
          
          Write-Host "`n=== FINAL DIAGNOSTICS ===" -ForegroundColor Yellow
          
          Write-Host "`n1. RDP Service:" -ForegroundColor Cyan
          Get-Service -Name TermService | Select-Object Name, Status, StartType | Format-Table
          
          Write-Host "2. Listening Ports:" -ForegroundColor Cyan
          Get-NetTCPConnection -LocalPort 3389 -State Listen -ErrorAction SilentlyContinue | Select-Object LocalAddress, LocalPort, State | Format-Table
          
          Write-Host "3. Firewall Status:" -ForegroundColor Cyan
          Get-NetFirewallProfile | Select-Object Name, Enabled | Format-Table
          
          Write-Host "4. RDP User:" -ForegroundColor Cyan
          Get-LocalUser -Name rdpuser | Select-Object Name, Enabled | Format-Table
          
          Write-Host "5. Local RDP Test:" -ForegroundColor Cyan
          $localTest = Test-NetConnection -ComputerName localhost -Port 3389 -InformationLevel Quiet -WarningAction SilentlyContinue
          if ($localTest) {
              Write-Host "   ‚úÖ RDP accepting connections" -ForegroundColor Green
          } else {
              Write-Host "   ‚ùå RDP NOT accepting connections" -ForegroundColor Red
          }
          
          Write-Host "`n========================`n" -ForegroundColor Yellow

      - name: Display Connection Info
        run: |
          $tsIP = Get-Content "$env:TEMP\tailscale_ip.txt" -Raw
          $tsIP = $tsIP.Trim()
          
          Write-Host ""
          Write-Host "============================================" -ForegroundColor Green
          Write-Host "  üñ•Ô∏è  RDP SERVER IS READY!" -ForegroundColor Green
          Write-Host "============================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "üìç CONNECTION DETAILS:" -ForegroundColor Yellow
          Write-Host "   IP: $tsIP" -ForegroundColor Cyan
          Write-Host "   Username: rdpuser" -ForegroundColor Cyan
          Write-Host "   Password: RDP@2024#Secure" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "üíª CONNECT:" -ForegroundColor Yellow
          Write-Host "   Windows: mstsc /v:$tsIP" -ForegroundColor White
          Write-Host "   Mac: Microsoft Remote Desktop" -ForegroundColor White
          Write-Host "   Linux: rdesktop $tsIP" -ForegroundColor White
          Write-Host ""
          Write-Host "‚úÖ STATUS:" -ForegroundColor Yellow
          Write-Host "   Firewall: DISABLED" -ForegroundColor Green
          Write-Host "   RDP: RUNNING" -ForegroundColor Green
          Write-Host "   Tailscale: CONNECTED" -ForegroundColor Green
          Write-Host "   Performance: OPTIMIZED" -ForegroundColor Green
          Write-Host ""
          Write-Host "============================================" -ForegroundColor Green
          Write-Host ""

      - name: Keep Alive
        run: |
          $tsIP = Get-Content "$env:TEMP\tailscale_ip.txt" -Raw
          $tsIP = $tsIP.Trim()
          
          $endTime = (Get-Date).AddHours(6)
          
          Write-Host "üî• Running for 6 hours..." -ForegroundColor Green
          Write-Host "üìå Connect to: $tsIP`n" -ForegroundColor Cyan
          
          while ((Get-Date) -lt $endTime) {
            $remaining = ($endTime - (Get-Date)).ToString("hh\:mm\:ss")
            
            $rdpRunning = Get-Service -Name TermService | Where-Object {$_.Status -eq 'Running'}
            $status = if ($rdpRunning) { "‚úÖ ONLINE" } else { "‚ùå OFFLINE" }
            
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] $status | ‚è∞ $remaining | üìç $tsIP" -ForegroundColor Cyan
            
            $wsh = New-Object -ComObject WScript.Shell
            $wsh.SendKeys('+{F15}')
            
            Start-Sleep -Seconds 300
          }
          
          Write-Host "`n‚èπÔ∏è 6 hour limit reached!" -ForegroundColor Yellow
