Write-Host "Starting Complete Self-Hosted RDP Setup..." -ForegroundColor Cyan

# ==========================================================
# USER CONFIGURATION
# ==========================================================
$username = "rdpadmin"
$password = "P@assword!q218"
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force

# ==========================================================
# CREATE ADMIN USER
# ==========================================================
if (-not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
    New-LocalUser -Name $username `
        -Password $securePassword `
        -FullName "RDP Administrator" `
        -Description "High Performance RDP Account" `
        -PasswordNeverExpires `
        -UserMayNotChangePassword
}

Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue
Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username -ErrorAction SilentlyContinue

Write-Host "User configured." -ForegroundColor Green

# ==========================================================
# ENABLE RDP
# ==========================================================
Set-ItemProperty `
  -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
  -Name "fDenyTSConnections" -Value 0

Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

Write-Host "RDP enabled." -ForegroundColor Green

# ==========================================================
# ENABLE ULTIMATE PERFORMANCE POWER PLAN
# ==========================================================
$scheme = powercfg -duplicatescheme e9a42b02-d5df-448d-aa00-03f14749eb61
$guid = ($scheme -split ' ')[3]
powercfg /s $guid

Write-Host "Ultimate Performance activated." -ForegroundColor Green

# ==========================================================
# NETWORK STABILITY OPTIMIZATION
# ==========================================================
netsh int tcp set global autotuninglevel=normal
netsh int tcp set global rss=enabled
netsh int tcp set global chimney=enabled
netsh int tcp set global ecncapability=enabled
netsh int tcp set global timestamps=disabled
netsh int tcp set global initialRto=2000

Write-Host "Network optimized." -ForegroundColor Green

# ==========================================================
# RDP PERFORMANCE TUNING
# ==========================================================
$policyPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services"
New-Item -Path $policyPath -Force -ErrorAction SilentlyContinue
Set-ItemProperty -Path $policyPath -Name "bEnforceGpuPreference" -Value 1 -Type DWord -Force

Set-ItemProperty `
  -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" `
  -Name "VisualFXSetting" `
  -Value 2 -Force

# Start RDP service
Start-Service -Name "TermService"
Start-Sleep -Seconds 5

# Set RDP service priority to High
$rdpProcess = Get-Process -Name svchost | Where-Object {
  (Get-CimInstance Win32_Service -Filter "ProcessId = $($_.Id)").Name -contains 'TermService'
}

if ($rdpProcess) {
    $rdpProcess.PriorityClass = 'High'
}

Write-Host "RDP optimized for performance." -ForegroundColor Green

# ==========================================================
# INSTALL TAILSCALE
# ==========================================================
Write-Host "Installing Tailscale..." -ForegroundColor Yellow

Invoke-WebRequest `
  -Uri https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe `
  -OutFile tailscale-setup.exe

Start-Process .\tailscale-setup.exe -ArgumentList "/S" -Wait

Write-Host "Tailscale installed." -ForegroundColor Green

# ==========================================================
# SET TAILSCALE TO AUTO START
# ==========================================================
Set-Service -Name Tailscale -StartupType Automatic
Start-Service Tailscale

Write-Host "Tailscale service set to auto-start." -ForegroundColor Green

# ==========================================================
# FINAL OUTPUT
# ==========================================================
Write-Host ""
Write-Host "=============================================" -ForegroundColor Cyan
Write-Host "SELF-HOSTED RDP SETUP COMPLETE" -ForegroundColor Cyan
Write-Host "=============================================" -ForegroundColor Cyan
Write-Host ""
Write-Host "Next step:"
Write-Host "Run: tailscale up"
Write-Host ""
Write-Host "Then get IP using:"
Write-Host "tailscale ip -4"
Write-Host ""
Write-Host "Login Details:"
Write-Host "Username: rdpadmin"
Write-Host "Password: P@assword!q218"
Write-Host ""
Write-Host "Reboot recommended."
Write-Host ""
