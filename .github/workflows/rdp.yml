Write-Host "Starting Maximum Performance RDP Setup..."

# ===============================
# USER CONFIGURATION
# ===============================
$username = "rdpadmin"
$password = "UltraFast2024!"
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force

# ===============================
# CREATE USER
# ===============================
if (-not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
    New-LocalUser -Name $username `
        -Password $securePassword `
        -FullName "RDP Admin" `
        -Description "High Performance RDP User" `
        -PasswordNeverExpires `
        -UserMayNotChangePassword
}

Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue
Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username -ErrorAction SilentlyContinue

Write-Host "User created successfully."

# ===============================
# ENABLE RDP
# ===============================
Set-ItemProperty `
  -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
  -Name "fDenyTSConnections" -Value 0

Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

Write-Host "RDP Enabled."

# ===============================
# ULTIMATE PERFORMANCE PLAN
# ===============================
$scheme = powercfg -duplicatescheme e9a42b02-d5df-448d-aa00-03f14749eb61
$guid = ($scheme -split ' ')[3]
powercfg /s $guid

Write-Host "Ultimate Performance Activated."

# ===============================
# ADVANCED NETWORK OPTIMIZATION
# ===============================
netsh int tcp set global autotuninglevel=normal
netsh int tcp set global rss=enabled
netsh int tcp set global chimney=enabled
netsh int tcp set global ecncapability=enabled
netsh int tcp set global timestamps=disabled
netsh int tcp set global initialRto=2000

Write-Host "Network optimized."

# ===============================
# RDP GPU OPTIMIZATION
# ===============================
$policyPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services"
New-Item -Path $policyPath -Force -ErrorAction SilentlyContinue
Set-ItemProperty -Path $policyPath -Name "bEnforceGpuPreference" -Value 1 -Type DWord -Force

# ===============================
# VISUAL PERFORMANCE
# ===============================
Set-ItemProperty `
  -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" `
  -Name "VisualFXSetting" `
  -Value 2 -Force

Write-Host "Visual effects optimized."

# ===============================
# PRIORITIZE RDP SERVICE
# ===============================
Start-Service -Name "TermService"
Start-Sleep -Seconds 5

$rdpProcess = Get-Process -Name svchost | Where-Object {
  (Get-CimInstance Win32_Service -Filter "ProcessId = $($_.Id)").Name -contains 'TermService'
}

if ($rdpProcess) {
    $rdpProcess.PriorityClass = 'High'
    Write-Host "RDP priority set to HIGH."
}

# ===============================
# INSTALL TAILSCALE
# ===============================
Write-Host "Installing Tailscale..."

Invoke-WebRequest `
  -Uri https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe `
  -OutFile tailscale.exe

Start-Process .\tailscale.exe -ArgumentList "/S" -Wait

Write-Host "Run the following to connect:"
Write-Host "tailscale up"
Write-Host ""
Write-Host "=================================="
Write-Host "RDP READY"
Write-Host "=================================="
Write-Host "Username: rdpadmin"
Write-Host "Password: UltraFast2024!"
Write-Host "=================================="
